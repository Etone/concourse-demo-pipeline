resources:
- name: code
  type: git
  icon: github
  source:
    uri: https://github.com/Etone/concourse-demo-code.git
    branch: main

- name: ci
  type: git
  icon: github
  source:
    uri: https://github.com/Etone/concourse-demo-pipeline.git
    branch: main
    paths:
    - tasks

- name: maven
  icon: docker
  type: registry-image
  check_every: 168h
  source:
    repository: maven

- name: busybox
  icon: docker
  type: registry-image
  check_every: 168h
  source:
    repository: busybox
    


jobs:
- name: generate-metadata
  plan:
  - get: code
    trigger: true
  - get: ci
- name: build-and-test
  plan:
  - in_parallel:  
    - get: code
      passed:
      - generate-metadata
      trigger: true
    - get: ci
      passed:
      - generate-metadata
    - get: maven
    - get: busybox
  - task: build-jar
    file: ci/tasks/build-java-maven.yaml
    image: maven
  - task: build-container
    file: ci/tasks/build-container.yaml
    image: busybox
- name: deploy
  plan:
  - get: ci
    passed:
    - generate-metadata